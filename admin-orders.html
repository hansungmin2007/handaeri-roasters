<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í˜ì´ì§€ - í•œëŒ€ë¦¬ ë¡œí„°ìŠ¤</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.6rem;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .action-btn {
      padding: 0.3rem 0.7rem;
      margin: 0.2rem;
      cursor: pointer;
    }
    #detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #00000088;
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #detail-modal .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: relative;
    }
    #detail-modal .modal-content button {
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>

<!-- ğŸ” Firebase + ê´€ë¦¬ì ì¸ì¦ -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB585bChkNk2ClCdkgq09j7m8-eo5163w",
    authDomain: "handaeri-auth-test.firebaseapp.com",
    databaseURL: "https://handaeri-auth-test-default-rtdb.firebaseio.com",
    projectId: "handaeri-auth-test",
    storageBucket: "handaeri-auth-test.appspot.com",
    messagingSenderId: "972715372745",
    appId: "1:972715372745:web:bb80e07ae160c6beb32dd8",
    measurementId: "G-8FV8RLZ52B"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const rtdb = firebase.database();

  auth.onAuthStateChanged(user => {
    if (!user) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      location.href = "login.html";
    } else {
      db.collection("users").doc(user.uid).get().then(doc => {
        if (!doc.exists || doc.data().role !== "admin") {
          alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
          location.href = "index.html";
        }
      });
    }
  });
</script>

<header class="header">
  <h1><a href="index.html" class="logo">í•œëŒ€ë¦¬ ë¡œí„°ìŠ¤</a></h1>
</header>

<main class="hero">
  <h2>ğŸ“¦ ê´€ë¦¬ì ì£¼ë¬¸ ëª©ë¡</h2>

  <div style="max-width: 800px; margin: 1rem auto; display: flex; gap: 1rem; align-items: center;">
    <input type="text" id="search-input" placeholder="ì´ë¦„ ê²€ìƒ‰" style="padding: 0.4rem; flex: 1;">
    <select id="status-filter" style="padding: 0.4rem;">
      <option value="">ì „ì²´</option>
      <option value="ë°°ì†¡ ì¤€ë¹„ ì¤‘">ë°°ì†¡ ì¤€ë¹„ ì¤‘</option>
      <option value="ë°°ì†¡ ì™„ë£Œ">ë°°ì†¡ ì™„ë£Œ</option>
    </select>
    <button onclick="renderOrders()">ê²€ìƒ‰</button>
    <button onclick="downloadCSV()">CSV ì €ì¥</button>
    <button onclick="downloadXLSX()">ì—‘ì…€ ì €ì¥</button>
  </div>

  <div style="max-width: 1000px; margin: auto;">
    <table>
      <thead>
        <tr>
          <th>ì£¼ë¬¸ë²ˆí˜¸</th>
          <th>ì´ë¦„</th>
          <th>ì£¼ì†Œ</th>
          <th>ì—°ë½ì²˜</th>
          <th>ìƒí’ˆ</th>
          <th>ìƒíƒœ</th>
          <th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody id="order-body"></tbody>
    </table>
  </div>
</main>

<!-- ìƒì„¸ ëª¨ë‹¬ -->
<div id="detail-modal">
  <div class="modal-content">
    <button onclick="closeModal()">âœ–</button>
    <h3>ğŸ“ ì£¼ë¬¸ ìƒì„¸</h3>
    <div id="modal-content" style="margin-top:1rem;"></div>
  </div>
</div>

<footer class="footer">
  &copy; 2025 í•œëŒ€ë¦¬ ë¡œí„°ìŠ¤
</footer>

<!-- ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§ ë° ê¸°ëŠ¥ -->
<script>
  const orders = JSON.parse(localStorage.getItem("allOrders") || "[]");

  function renderOrders() {
    const tbody = document.getElementById("order-body");
    const search = document.getElementById("search-input").value.toLowerCase();
    const filter = document.getElementById("status-filter").value;
    tbody.innerHTML = "";

    const filtered = orders.filter(order => {
      const matchName = order.customer.name.toLowerCase().includes(search);
      const matchStatus = filter ? order.status === filter : true;
      return matchName && matchStatus;
    });

    if (filtered.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7'>ì£¼ë¬¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
      return;
    }

    filtered.forEach(order => {
      const row = document.createElement("tr");
      const products = order.items.map(i => `${i.name} (${i.qty}ê°œ)`).join("<br>");
      row.innerHTML = `
        <td>${order.id}</td>
        <td>${order.customer.name}</td>
        <td>${order.customer.address}</td>
        <td>${order.customer.phone}</td>
        <td>${products}</td>
        <td id="status-${order.id}">${order.status}</td>
        <td>
          <button class="action-btn" onclick="viewDetail(${order.id})">ìƒì„¸</button>
          <button class="action-btn" onclick="changeStatus(${order.id})">ë°°ì†¡ ì™„ë£Œ</button>
          <button class="action-btn" style="color:red;" onclick="deleteOrder(${order.id})">ì‚­ì œ</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function changeStatus(id) {
    const index = orders.findIndex(o => o.id === id);
    if (index !== -1) {
      orders[index].status = "ë°°ì†¡ ì™„ë£Œ";
      localStorage.setItem("allOrders", JSON.stringify(orders));
      document.getElementById(`status-${id}`).innerText = "ë°°ì†¡ ì™„ë£Œ";
      alert("ë°°ì†¡ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      rtdb.ref("orders/" + id).update({ status: "ë°°ì†¡ ì™„ë£Œ" });
    }
  }

  function deleteOrder(id) {
    if (!confirm("ì´ ì£¼ë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const updated = orders.filter(o => o.id !== id);
    localStorage.setItem("allOrders", JSON.stringify(updated));
    rtdb.ref("orders/" + id).remove();
    location.reload();
  }

  function downloadCSV() {
    const header = ["ì£¼ë¬¸ë²ˆí˜¸", "ì´ë¦„", "ì£¼ì†Œ", "ì—°ë½ì²˜", "ìƒí’ˆ", "ìƒíƒœ"];
    const rows = orders.map(o => [
      o.id,
      o.customer.name,
      o.customer.address,
      o.customer.phone,
      o.items.map(i => `${i.name}(${i.qty})`).join("; "),
      o.status
    ]);
    let csvContent = [header, ...rows].map(e => e.join(",")).join("\\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "order_list.csv";
    link.click();
  }

  function downloadXLSX() {
    const wb = XLSX.utils.book_new();
    const ws_data = [
      ["ì£¼ë¬¸ë²ˆí˜¸", "ì´ë¦„", "ì£¼ì†Œ", "ì—°ë½ì²˜", "ìƒí’ˆ", "ìƒíƒœ"],
      ...orders.map(o => [
        o.id,
        o.customer.name,
        o.customer.address,
        o.customer.phone,
        o.items.map(i => `${i.name}(${i.qty})`).join("; "),
        o.status
      ])
    ];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Orders");
    XLSX.writeFile(wb, "orders.xlsx");
  }

  function viewDetail(id) {
    const order = orders.find(o => o.id === id);
    if (!order) return;
    const content = `
      <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${order.id}</p>
      <p><strong>ì´ë¦„:</strong> ${order.customer.name}</p>
      <p><strong>ì£¼ì†Œ:</strong> ${order.customer.address}</p>
      <p><strong>ì—°ë½ì²˜:</strong> ${order.customer.phone}</p>
      <p><strong>ìƒíƒœ:</strong> ${order.status}</p>
      <p><strong>ìƒí’ˆ:</strong><br>${order.items.map(i => `- ${i.name} (${i.qty}ê°œ)`).join("<br>")}</p>
    `;
    document.getElementById("modal-content").innerHTML = content;
    document.getElementById("detail-modal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("detail-modal").style.display = "none";
  }

  renderOrders();
</script>

</body>
</html>
